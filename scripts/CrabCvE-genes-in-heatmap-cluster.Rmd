---
title: "Get genes in clusters"
output: html_document
---
Rmd to get the genes that are in the clusters of the heatmap comparing Crabs C and E across all time points with the infection DEG list. 

```{r}
library(pheatmap)
library(dplyr)
```

### Make heatmap in this Rmd to make things easier: 
Read in normalized counts: 
```{r}
norm_counts <- read.delim("../data/salmon.isoform.TMM.EXPR.matrix")
head(norm_counts)
```
40,035 rows of normalized count data for 24 samples

Rename columns: 
```{r}
colnames(norm_counts) <- c("Trinity_ID", "CrabH_2", "CrabE_2", "CrabI_2", "CrabC_17", "CrabB_17", "CrabG_0", "CrabF_2", "CrabE_0", "CrabG_2", "CrabC_0", "CrabI_0", "CrabD_0", "CrabD_17", "CrabB_0", "CrabC_2", "CrabB_2", "CrabF_17", "CrabA_0", "CrabH_0", "CrabA_17", "CrabD_2", "CrabE_17", "CrabA_2", "CrabF_0")
head(norm_counts)
```

Read in Temperature DEG list (772)
```{r}
infection_degs <- read.delim("../analyses/DEG-infection.txt", header = TRUE)
head(infection_degs)
```
`join` with norm_counts by "Trinity_ID"
```{r}
infection_degs_counts <- left_join(norm_counts, infection_degs, by = "Trinity_ID")
head(infection_degs_counts)
```

Just want the ones that match! (list of 772)
```{r}
infectdegs_counts_match <- filter(infection_degs_counts, baseMean != "NA")
head(infectdegs_counts_match)
```

**Crab C and E all time points with infection DEGs**
_This one will be used for thesis defense_ 
Pull out just the sample count data:
```{r}
infectiondegs_CvE <- select(infectdegs_counts_match, Trinity_ID, CrabC_0, CrabC_2, CrabC_17, CrabE_0, CrabE_2, CrabE_17)
head(infectiondegs_CvE)
```

Set Trinity_ID as row names:
```{r}
rownames(infectiondegs_CvE) <- infectiondegs_CvE$Trinity_ID #set Trinity IDs as rownames
infectiondegs_CvE.heatmap <-infectiondegs_CvE[,-1] #remove redundant column
head(infectiondegs_CvE.heatmap)
```

I think I should try to remove rows that have 0 all the way across:
```{r}
noz_infectiondegs_CvE.heatmap <- infectiondegs_CvE.heatmap[rowSums(infectiondegs_CvE.heatmap[, -1] >0) !=0, ]
head(noz_infectiondegs_CvE.heatmap)
```
366 rows! 

Create heatmap color scheme so that value of 0 is white:
```{r}
heatmapRedBlue <- RColorBrewer::brewer.pal(11, "RdBu")
```

```{r}
pheatmap(noz_infectiondegs_CvE.heatmap, scale = "row", cluster_row = TRUE, cluster_cols = FALSE, clustering_distance_rows = "euclidean", clustering_method = "average", show_rownames = FALSE, show_colnames = TRUE, treeheight_col = 80, legend = TRUE, color = heatmapRedBlue, fontsize_col = 20, fontsize_row = 12)
```

## Get genes in the clusters
Set the heatmap as an object called "results": 

```{r}
results <- pheatmap(noz_infectiondegs_CvE.heatmap, scale = "row", cluster_row = TRUE, cluster_cols = FALSE, clustering_distance_rows = "euclidean", clustering_method = "average", show_rownames = FALSE, show_colnames = TRUE, treeheight_col = 80, legend = TRUE, color = heatmapRedBlue, fontsize_col = 20, fontsize_row = 12)
```

From: https://www.biostars.org/p/287512/ 

```{r}
#re-order the data used to create the heatmap in the same order as what is shown in the heatmap (top to bottom)
reorg_CvE_genes <- rownames(noz_infectiondegs_CvE.heatmap[results$tree_row[["order"]],])
# print(reorg_CvE_genes)
```
366 characters - matches the 366 rows of genes

```{r}
#now 'cut' the data into a pre-selected number of groups. 
#not really sure how to figure out number of groups... but there seems to be 6 big blue clusters in the Crab C and Crab E heatmap...
sixclust <- sort(cutree(results$tree_row, k=6))
head(sixclust)
```

Try plotting the cluster dendrogram
```{r}
plot(results$tree_row)
abline(h=7, col = "red", lty = 2, lwd =2)
```

Cut the row (gene) dendrogram at a Euclidean distance dis-similarity of 8 (what does that mean?)
```{r}
euc_clust <- sort(cutree(results$tree_row, h =7))
#print(euc_clust)
```
All in group 1.... not useful. 

try another thing from the biostars page: 
```{r}
#clusDesignation <- cutree(as.hclust(results$colDendrogram),2)
#clusDesignation[clusDesignation==1]
#clusDesignation[clusDesignation==2]
```
Error in as.hclust.default(results$colDendrogram) : argument 'x' cannot be coerced to class “hclust”character(0)



# I think the following method works!!! 
Though it is kinda messy

https://stackoverflow.com/questions/27820158/pheatmap-in-r-how-to-get-clusters 

```{r}
results.clust <- cbind(noz_infectiondegs_CvE.heatmap, cluster = cutree(results$tree_row, k = 6))
head(results.clust)
```

Clusters are actually numbered! But which cluster is which? Is 1 the cluster in Crab C_0? Is six the cluster in Crab E _17?

It would be helpful if I could use the reorg_CvE_genes made in the previous method for this. 

I think actually, it can be figured out based on the count data. For example:    
The first gene "TRINITY_DN5315_c0_g1_i1" is only listed as being present in CrabC_17... and cluster designation is 1. So, CrabC_17 is cluster1. 

## Get list of genes for each cluster
First: 
Set rownames as a column called Trinity ID
```{r}
res.clusts <- results.clust
names <- rownames(res.clusts)
rownames(res.clusts) <- NULL
final_clust_res <- cbind(names, res.clusts)
head(final_clust_res)
```
Rename column as Trinity ID
```{r}
colnames(final_clust_res) <- c("Trinity_ID", "CrabC_0", "CrabC_2", "CrabC_17", "CrabE_0", "CrabE_2", "CrabE_17", "cluster")
head(final_clust_res)
```

Pull out genes for each cluster: 
```{r}
clust_crabC0 <- filter(final_clust_res, cluster == 6)
head(clust_crabC0)
```

```{r}
clust_crabC2 <- filter(final_clust_res, cluster == 3)
head(clust_crabC2)
```


```{r}
#crabC_17 is cluster1 
clust_crabC17 <- filter(final_clust_res, cluster == 1)
head(clust_crabC17)
```

```{r}
clust_crabE0 <- filter(final_clust_res, cluster == 2)
head(clust_crabE0)
```

```{r}
clust_crabE2 <- filter(final_clust_res, cluster == 5)
head(clust_crabE2)
```

```{r}
clust_crabE17 <- filter(final_clust_res, cluster == 4)
head(clust_crabE17)
```





